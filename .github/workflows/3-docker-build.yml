name: 3ï¸âƒ£ Docker Build (C13 + C19)

# CompÃ©tence C13: Concevoir la chaÃ®ne de livraison continue d'un modÃ¨le 
# d'intelligence artificielle (MLOps)
# â†’ Construction et packaging des images Docker
#
# CompÃ©tence C19: GÃ©rer les incidents et les demandes d'assistance des 
# utilisateurs d'une solution applicative
# â†’ Assurer la fiabilitÃ© du dÃ©ploiement

on:
  push:
    branches: [ main, monitoring_grafana_evidently, develop, nettoyage_clean_code_final ]
  pull_request:
    branches: [ main, monitoring_grafana_evidently ]
  workflow_dispatch:

jobs:
  build-images:
    name: Build Docker Image - ${{ matrix.service }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    strategy:
      fail-fast: false
      matrix:
        service: [api, etl, ml, streamlit, mlflow]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ‹ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ðŸ’¾ Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ matrix.service }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ matrix.service }}-
      
      - name: ðŸ”¨ Build ${{ matrix.service }} image
        run: |
          docker compose build ${{ matrix.service }}
      
      - name: ðŸ’¾ Save image as artifact
        run: |
          docker save lets-go-predictiondex-${{ matrix.service }} | gzip > ${{ matrix.service }}.tar.gz
      
      - name: ðŸ“¤ Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ matrix.service }}
          path: ${{ matrix.service }}.tar.gz
          retention-days: 1
      
      - name: âœ… Build success
        run: |
          echo "âœ… Image ${{ matrix.service }} built successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          docker images | grep lets-go-predictiondex-${{ matrix.service }} >> $GITHUB_STEP_SUMMARY || true
