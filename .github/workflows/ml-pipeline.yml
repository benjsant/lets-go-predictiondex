name: ML Pipeline

on:
  push:
    branches: [ main, monitoring_grafana_evidently ]
    paths:
      - 'machine_learning/**'
      - 'data/ml/**'
      - 'models/**'
  workflow_dispatch:
    inputs:
      dataset_version:
        description: 'Dataset version (v1 or v2)'
        required: true
        default: 'v2'
        type: choice
        options:
          - v1
          - v2
      model_version:
        description: 'Model version suffix'
        required: true
        default: 'ci'

jobs:
  test-ml:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: letsgo_db
          POSTGRES_USER: letsgo_user
          POSTGRES_PASSWORD: letsgo_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      mlflow:
        image: ghcr.io/mlflow/mlflow:v2.9.2
        env:
          MLFLOW_BACKEND_STORE_URI: sqlite:///mlflow.db
        ports:
          - 5000:5000
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r machine_learning/requirements.txt
          pip install pytest pytest-cov
      
      - name: Set environment variables
        run: |
          echo "POSTGRES_HOST=localhost" >> $GITHUB_ENV
          echo "POSTGRES_PORT=5432" >> $GITHUB_ENV
          echo "MLFLOW_TRACKING_URI=http://localhost:5000" >> $GITHUB_ENV
          echo "PYTHONPATH=$PWD" >> $GITHUB_ENV
      
      - name: Run ML tests
        run: |
          pytest tests/ml/ -v --cov=machine_learning --cov-report=xml
      
      - name: Train model (if manual trigger)
        if: github.event_name == 'workflow_dispatch'
        run: |
          python machine_learning/run_machine_learning.py \
            --mode=train \
            --dataset-version=${{ github.event.inputs.dataset_version }} \
            --version=${{ github.event.inputs.model_version }}
      
      - name: Validate model metrics
        if: github.event_name == 'workflow_dispatch'
        run: |
          python -c "
          import json
          from pathlib import Path
          metadata_path = Path('models/battle_winner_metadata_${{ github.event.inputs.model_version }}.json')
          with open(metadata_path) as f:
              meta = json.load(f)
          acc = meta['metrics']['test_accuracy']
          print(f'Test Accuracy: {acc:.4f}')
          assert acc > 0.80, f'Accuracy too low: {acc}'
          print('✅ Model validation passed')
          "
      
      - name: Upload model artifacts
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v3
        with:
          name: model-${{ github.event.inputs.model_version }}
          path: |
            models/battle_winner_model_${{ github.event.inputs.model_version }}.pkl
            models/battle_winner_metadata_${{ github.event.inputs.model_version }}.json
            models/battle_winner_scalers_${{ github.event.inputs.model_version }}.pkl
          retention-days: 90
      
      - name: Comment PR with metrics
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ ML tests passed! Model metrics will be available after training.'
            })
