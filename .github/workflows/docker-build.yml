name: Docker Build

on:
  push:
    branches: [ main, monitoring_grafana_evidently, develop ]
  pull_request:
    branches: [ main, monitoring_grafana_evidently ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    strategy:
      matrix:
        service: [api, etl, ml, streamlit, mlflow]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ matrix.service }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ matrix.service }}-
      
      - name: Build ${{ matrix.service }} image
        run: |
          docker compose build ${{ matrix.service }}
      
      - name: Save image
        run: |
          docker save lets-go-predictiondex-${{ matrix.service }} | gzip > ${{ matrix.service }}.tar.gz
      
      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-${{ matrix.service }}
          path: ${{ matrix.service }}.tar.gz
          retention-days: 1

  integration-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: build-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Load Docker images
        run: |
          for service in api etl ml streamlit mlflow; do
            if [ -f docker-$service/$service.tar.gz ]; then
              gunzip -c docker-$service/$service.tar.gz | docker load
            fi
          done
      
      - name: Create .env file
        run: |
          cat > .env << EOF
          POSTGRES_HOST=db
          POSTGRES_PORT=5432
          POSTGRES_DB=letsgo_db
          POSTGRES_USER=letsgo_user
          POSTGRES_PASSWORD=letsgo_password
          DEV_MODE=true
          API_KEY_REQUIRED=false
          API_KEYS=test_key_for_ci_cd
          EOF
      
      - name: Start services
        run: |
          docker compose up -d
          echo "⏳ Waiting for services to be ready..."

      - name: Wait for PostgreSQL
        run: |
          echo "Waiting for PostgreSQL..."
          timeout 90 bash -c 'until docker compose exec -T db pg_isready -U letsgo_user; do sleep 2; done'
          echo "✅ PostgreSQL ready"

      - name: Wait for API
        run: |
          echo "Waiting for API..."
          timeout 120 bash -c 'until curl -sf http://localhost:8080/health; do sleep 3; done'
          echo "✅ API ready"

      - name: Wait for MLflow
        run: |
          echo "Waiting for MLflow..."
          timeout 90 bash -c 'until curl -sf http://localhost:5001/health; do sleep 3; done'
          echo "✅ MLflow ready"

      - name: Wait for Prometheus
        run: |
          echo "Waiting for Prometheus..."
          timeout 60 bash -c 'until curl -sf http://localhost:9091/-/healthy; do sleep 3; done'
          echo "✅ Prometheus ready"
      
      - name: Run integration tests
        run: |
          # Run integration tests from within the API container
          docker compose exec -T api pytest tests/integration/ -v
      
      - name: Show logs on failure
        if: failure()
        run: |
          docker compose logs
      
      - name: Stop services
        if: always()
        run: |
          docker compose down -v
