name: 4ï¸âƒ£ Integration Tests (C13 + C19)

# CompÃ©tence C13: Concevoir la chaÃ®ne de livraison continue d'un modÃ¨le 
# d'intelligence artificielle (MLOps)
# â†’ Tests d'intÃ©gration avec Docker Compose, validation end-to-end
#
# CompÃ©tence C19: GÃ©rer les incidents et les demandes d'assistance des 
# utilisateurs d'une solution applicative
# â†’ Validation complÃ¨te du systÃ¨me

on:
  workflow_run:
    workflows: ["3ï¸âƒ£ Docker Build (C13 + C19)"]
    types:
      - completed
    branches: [ main, develop, nettoyage_clean_code_final ]
  workflow_dispatch:

jobs:
  integration-tests:
    name: Integration Tests (Full Docker Stack)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Ne s'exÃ©cute que si le workflow prÃ©cÃ©dent a rÃ©ussi
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“¥ Download all Docker images
        uses: actions/download-artifact@v4
        with:
          path: docker-images/
        continue-on-error: true
      
      - name: ðŸ‹ Load Docker images (if available)
        run: |
          if [ -d "docker-images/" ]; then
            for service in api etl ml streamlit mlflow; do
              if [ -f docker-images/docker-image-$service/$service.tar.gz ]; then
                echo "Loading $service image..."
                gunzip -c docker-images/docker-image-$service/$service.tar.gz | docker load
              fi
            done
          else
            echo "No pre-built images found, will build from scratch"
          fi
      
      - name: ðŸ”§ Create .env file
        run: |
          cat > .env << EOF
          POSTGRES_USER=letsgo_user
          POSTGRES_PASSWORD=letsgo_password
          POSTGRES_DB=letsgo_db
          POSTGRES_HOST=db
          POSTGRES_PORT=5432
          DEV_MODE=true
          API_KEY_REQUIRED=true
          API_KEYS=test_key_for_github_actions,BgQJ2_Ur4uYKBsw6Jf4TI_yfA6u0BFwb4a1YbOSmMVQ
          DISABLE_MLFLOW_TRACKING=false
          USE_MLFLOW_REGISTRY=false
          ML_SKIP_IF_EXISTS=true
          EOF
      
      - name: ðŸš€ Start Docker Compose stack
        run: |
          echo "ðŸ³ Starting all services..."
          docker compose up -d
          echo "â³ Waiting for services to be ready..."
      
      - name: â³ Wait for PostgreSQL
        run: |
          echo "Waiting for PostgreSQL..."
          timeout 120 bash -c 'until docker compose exec -T db pg_isready -U letsgo_user; do sleep 2; done'
          echo "âœ… PostgreSQL ready"
      
      - name: â³ Wait for API
        run: |
          echo "Waiting for API..."
          timeout 180 bash -c 'until curl -sf http://localhost:8080/health; do sleep 3; done'
          echo "âœ… API ready"
      
      - name: â³ Wait for MLflow
        run: |
          echo "Waiting for MLflow..."
          timeout 120 bash -c 'until curl -sf http://localhost:5001/health; do sleep 3; done'
          echo "âœ… MLflow ready"
      
      - name: â³ Wait for Prometheus
        run: |
          echo "Waiting for Prometheus..."
          timeout 90 bash -c 'until curl -sf http://localhost:9091/-/healthy; do sleep 3; done'
          echo "âœ… Prometheus ready"
      
      - name: â³ Wait for Grafana
        run: |
          echo "Waiting for Grafana..."
          timeout 90 bash -c 'until curl -sf http://localhost:3001/api/health; do sleep 3; done'
          echo "âœ… Grafana ready"
      
      - name: ðŸ§ª Run integration tests
        run: |
          echo "ðŸ§ª Running integration tests..."
          docker compose exec -T api pytest tests/integration/ -v --tb=short
      
      - name: ðŸ” Validate services health
        run: |
          echo "ðŸ” Checking all services health..."
          
          # API
          curl -f http://localhost:8080/health || exit 1
          echo "âœ… API health check passed"
          
          # MLflow
          curl -f http://localhost:5001/health || exit 1
          echo "âœ… MLflow health check passed"
          
          # Prometheus
          curl -f http://localhost:9091/-/healthy || exit 1
          echo "âœ… Prometheus health check passed"
          
          # Grafana
          curl -f http://localhost:3001/api/health || exit 1
          echo "âœ… Grafana health check passed"
      
      - name: ðŸ“Š Generate test summary
        if: always()
        run: |
          echo "## ðŸ§ª Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Validated:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PostgreSQL" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… API (FastAPI)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… MLflow Tracking Server" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Prometheus" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Grafana" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tests Executed:" >> $GITHUB_STEP_SUMMARY
          echo "- Integration tests" >> $GITHUB_STEP_SUMMARY
          echo "- Health checks" >> $GITHUB_STEP_SUMMARY
          echo "- Service connectivity" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“‹ Show logs on failure
        if: failure()
        run: |
          echo "ðŸ“‹ Docker Services Status:"
          docker compose ps
          echo ""
          echo "ðŸ“‹ Last 100 lines of logs:"
          docker compose logs --tail=100
      
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up Docker resources..."
          docker compose down -v || true
          docker system prune -f || true
