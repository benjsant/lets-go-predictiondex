name: 2ï¸âƒ£ Unit Tests (C12)

# CompÃ©tence C12 (E3): Programmer les tests automatisÃ©s d'un modÃ¨le 
# d'intelligence artificielle
# â†’ Tests unitaires rapides sans Docker
# â†’ Tests de validation des jeux de donnÃ©es, prÃ©paration, entraÃ®nement, 
#    Ã©valuation et validation du modÃ¨le

on:
  push:
    branches: [ main, monitoring_grafana_evidently, develop, prototype_final_v1, nettoyage_clean_code_final ]
  pull_request:
    branches: [ main, monitoring_grafana_evidently ]

jobs:
  unit-tests:
    name: Fast Unit Tests (No Docker)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: letsgo_test
          POSTGRES_USER: letsgo_user
          POSTGRES_PASSWORD: letsgo_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    strategy:
      matrix:
        python-version: ['3.11']
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio httpx
          pip install -r api_pokemon/requirements.txt
          pip install -r machine_learning/requirements.txt
      
      - name: ðŸ”§ Set environment variables
        run: |
          echo "POSTGRES_HOST=localhost" >> $GITHUB_ENV
          echo "POSTGRES_PORT=5432" >> $GITHUB_ENV
          echo "POSTGRES_DB=letsgo_test" >> $GITHUB_ENV
          echo "POSTGRES_USER=letsgo_user" >> $GITHUB_ENV
          echo "POSTGRES_PASSWORD=letsgo_password" >> $GITHUB_ENV
          echo "PYTHONPATH=$PWD" >> $GITHUB_ENV
      
      - name: ðŸ§ª Run unit tests (fast)
        continue-on-error: false
        run: |
          # Tests essentiels uniquement pour CI/CD rapide
          # Focus sur ML (C12) + quelques tests API critiques
          pytest tests/ml/ tests/api/test_health.py \
            -v --tb=short -m "not slow" \
            --cov=machine_learning \
            --cov-report=xml --cov-report=term-missing || {
            # CrÃ©er fichiers coverage vides si tests Ã©chouent
            echo '<?xml version="1.0" ?><coverage version="7.0"><packages/></coverage>' > coverage.xml
            touch .coverage
            exit 1
          }
      
      - name: ðŸ“Š Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
      
      - name: ðŸ“¦ Archive test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-unit
          path: |
            coverage.xml
            .coverage
          retention-days: 30
          if-no-files-found: warn
      
      - name: âœ… Summary
        if: success()
        run: |
          echo "## âœ… Unit Tests Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage Report:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          coverage report >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
